---
html_document:
  df_print: paged
author: "Sanyam Jain"
title: "IA1 - Supply Chain Analytics"
output:
  html_document:
    df_print: paged
---

***
<center>
## Individual Assignment #1: ETS Laboratory
#### By: Sanyam Jain (sj33448)
</center>
***

You have been hired by a company in the hospitality business to help them plan the staffing levels for the following year.  The company operates resorts in three regions of the New South Wales of Australia; the three regions are the **Sydney**, the **South Coast** and the **North Coast NSW** areas.

As it takes time to hire new personnel and it is necessary for any new employee to undergo a detailed training program before starting to work, the company needs to plan its personnel requirements one year in advance.  Furthermore, as it is possible for the company to transfer qualified personnel between regions, they are interested only in an aggregate forecast of their demand 

As the company caters to **Holiday** travelers, and it has been growing faster than the market (i.e., it has been gaining market share), the Chief Commercial Officer estimates that next year they will have respectively (3%, 4%, 4%) of only the **Holiday** travelers in the (**Sydney**, **South Coast**, and **North Coast NSW**) regions respectively.  Furthermore based on prior experience they anticipate that each traveler will stay respectively (5,2,2) hotel-nights in (**Sydney**, **South Coast**, and **North Coast NSW**) respectively

To forecast demand in hotel-nights use the **tourism** data set in **fpp3**.  This data set reports the quarterly trips (in thousands) to different destinations, and as this data set has a *tsibble* structure, you can use **tidyverse** functions to subset the time-series of interest.  

For the purposes of this assignment ignore all data before **2008 Q1** and use the data from **2008 Q1** through **2016 Q4** as a training set and the four quarters of **2017** as a testing set.



### Part I.  Model-Aggregation Forecast 

1. After sub-setting for the time-series of interest in the **tourism** data set (a *tsibble*), add to the restricted set the corresponding demand time-series, by creating a column called *Demand*  for each of the corresponding regions of interest.  The *Demand* column should contain the hotel-nights (in thousands) corresponding to each of the *Trips* observations. After creating the *Demand* column, the code below uses the **group_by()** function to aggregate demand across regions creating the *AGG.D* column with the total demand and you are asked to find the best **ETS** model for each *Demand* time-series. In addition to the automatic fit, one of your colleagues suggest that you should find the best model that includes an additive trend "A" and the best model that includes an additive-damped "Ad" trend, as the automatic selection is based only on the AICc criterion, and the models with trend may be better under the *BIC* criterion.  Report the best model as well as the corresponding *AICc* and *BIC*. What is the best model according to the information criteria?


```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(fpp3)

tourism %>% 
  filter(Quarter >= yearquarter("2008 Q1")) %>%
  filter(Purpose == "Holiday" & State == "New South Wales") %>%
  filter(Region %in% c("North Coast NSW","South Coast","Sydney")) %>%
  mutate(Demand = case_when(
    Region == "Sydney" ~ 0.03*Trips*5,
    Region == "South Coast" ~ 0.04*Trips*2,
    Region == "North Coast NSW" ~ 0.04*Trips*2
  )) -> D

D %>%
  group_by() %>%
  summarize(AGG.D = sum(Demand)) -> AD

# Break into Training and Testing sets.

ADTR <- AD %>% 
  filter(Quarter <= yearquarter("2016 Q4"))
ADTE <- AD %>% 
  filter(Quarter >= yearquarter("2017 Q1"))
```

``` {r}

mod <- ADTR %>%  
  model(mod_1.auto = ETS(AGG.D),
        mod_2.A = ETS(AGG.D ~trend("A")),
        mod_3.Ad = ETS(AGG.D ~ trend("Ad")))
mod

mod %>% glance() %>% select(.model,AIC,AICc,BIC)

```
```{r}
mod
mod %>% glance() %>%filter(AICc == min(AICc) | BIC == min(BIC))
```

Best Model :mod1_auto (A,N,A) with AICc = 310.8655 & BIC  = 317.9501



2. Now calculate the in-sample (training) and the out-of-sample (testing) metrics for each of the three models fitted in (1). 

```{r}
train_acc <- mod %>% accuracy()
fcst_acc = mod %>% forecast(h=length(ADTE$Quarter)) %>% accuracy(ADTE)
rbind(train_acc,fcst_acc) %>% select(.model, .type, MAPE, RMSE, ACF1)
```

3. Using the type of model with the lowest out-of-sample *MAPE*, fit its parameters using all data (i.e., the *AD* data set) and prepare a forecast for the four quarters of 2018. Please report the point forecasts as well as the 80% and 95% confidence intervals.

From above table, Additive Model (mod_2.A) has the lowest out-of-sample MAPE (4.797095). For getting forecast of this model:
```{r}

mod_data_all <- AD %>% model(ETS = ETS(AGG.D ~ trend("A")))
frc <- mod_data_all %>% forecast(h=4) 
frc

frc %>%
  hilo(level =c(80,95)) %>%
  unpack_hilo(c("80%","95%"))
```
Above table has point forecasts (mean) along with the confidence intervals of 80% and 95%.
Forecast plot is as follows:
```{r}
frc %>% autoplot(AD)

```

4. As in the hospitality business it is very costly to be short of personnel and your brand gets degraded when demand exceeds staffing capacity, we need to plan the staffing levels for each quarter according to a forecast of demand that we anticipate it will not be exceeded with a probability of 99%.  What are these four quarterly demand levels?

```{r}

frc %>% mutate(Q99 = quantile(AGG.D, 0.99))

frc %>% mutate(Q99 = quantile(AGG.D, 0.99)) %>% autoplot()
```


### Part II. Infrastructure Capacity Planning Forecast

As the resort infrastructure (e.g., buildings) and its direct fixed expenses cannot be moved across regions, it is important to carefully select the levels of capacity we should build in each region.  To accomplish this we must forecast demand individually for each region, and then quantify the anticipated levels of occupation and the downside operational risk for each region.

5. Use the region-specific training and testing data (see code box below) and automatically select the ETS model that minimizes *AICc*, and as your colleague suggested also find the best model that includes an additive trend "A" and the best model that includes an additive-damped "Ad" trend as they may be preferred under the *BIC* criterion. Your *mable* should have 9 models in all; three models for each of the three regions. Report for each of the three models the corresponding *AICc* and *BIC* for each region. What is the ETS-name of the best model for each region according to the *AICc* information criterion? What is the best model for each region according to the *BIC* information criterion?


```{r}

DTR <- D %>% 
  filter(Quarter <= yearquarter("2016 Q4"))
DTE <- D %>% 
  filter(Quarter >= yearquarter("2017 Q1"))

reg_mod <- DTR %>% 
  model(reg_mod1.auto = ETS(Demand),
                   reg_mod2.A = ETS(Demand ~trend("A")),
                   reg_mod3.Ad = ETS(Demand ~ trend("Ad")))
reg_mod

reg_mod %>% glance() %>% select(Region,.model,AIC,AICc,BIC)
```
The best model for each region is the auto-generated model as it has the lowest AICc and BIC.
North Coast NSW = M,N,M
South Coast = M,N,M
Sydney = A,N,A


6. Calculate the in-sample (training) and the out-of-sample (testing) metrics for each of the nine models fitted in (5). Sometimes the damped models can introduce a bias in forecasting horizons longer than one or two periods. Is this a concern for the "Ad" model for any of the three regions? Explain.    Using for each region the type of model with the lowest *BIC* and fit its parameters using all data (i.e., the *D* data set) prepare a region-specific forecast for the four quarters of 2018 and report the point forecasts as well as the 80% and 95% confidence intervals.

```{r}

train_df <- reg_mod %>% accuracy()
test_df = reg_mod %>% forecast(h=length(DTE$Quarter)/3) %>% accuracy(DTE)
rbind(train_df,test_df) %>% select(Region, .model, .type, ME, RMSE, MAPE)
```

The Additive Damped trend model has the highest prediction errors for North Coast SW and Sydney, indicating it's less reliable there compared to other models. For the South Coast, its lower error suggests it's not as much of a concern.

Fitting the best model with all the data and forecasting:

```{r}
reg_mod_all <- D %>% model(ETS = ETS(Demand))
reg_mod_frc <- reg_mod_all %>% forecast(h=4)
reg_mod_frc
reg_mod_frc %>% autoplot(D)

reg_mod_frc %>%
  hilo(level =c(80,95)) %>%
  unpack_hilo(c("80%","95%"))
```


7. As infrastructure (buildings, etc) cannot be modified from quarter to quarter, i.e., once you build a number of hotel rooms you cannot easily sell them, we must plan carefully for the capacity level for the entire year in each of the three regions.  As with personnel, management thinks it is too expensive to be out of capacity to satisfy demand, and have proposed to build enough capacity to satisfy all demand of the highest season with a probability of 98%.  What is the constant capacity that they should build in each region to meet this service level? If we define the quarterly mean-forecast occupancy rate as the occupancy rate implied by the mean quarterly forecast, prepare a table showing the mean-forecast occupancy rate for each of the four quarters at each of the three regions. 


Initially, we must identify the highest demand within the four quarters, as this will determine the capacity that needs to be established.

```{r}
q_val <- reg_mod_frc %>% mutate(Q98 = quantile(Demand,0.98))

q_val
```

From the above table, maximum capacity is in Q1 for all three regions.Hence capacity for: 
North Coast NSW = 75.564 
South Coast = 79.36039
Sydney = 112.73246

```{r}
capacity <- c("North Coast"= 75.564, "South Coast"=79.36039, "Sydney"= 112.73246)


reg_mod_frc %>% 
  as_tibble() %>%
  mutate(occupancy_rate = case_when(
    Region == "North Coast NSW" ~ .mean / capacity["North Coast"] * 100,
    Region == "South Coast" ~ .mean / capacity["South Coast"] * 100,
    Region == "Sydney" ~ .mean / capacity["Sydney"] * 100
  )) %>%
  select(Region, Quarter, occupancy_rate)

```


8. Another metric of interest is the quarterly 10%-down-side occupancy risk.  This will be measured as the occupancy rate that would be obtained if actual demand outcome is at the low 10% of the probability distribution of its forecast. What is the 10% level of the forecast probability distribution for each quarter at each region. Prepare also a table showing the 10%-downside-occupancy implied by tour construction plan in Question 7 for each quarter at each region.

```{r}
reg_mod_frc_10q <- reg_mod_frc %>% mutate(Q10 = quantile(Demand,0.1))
reg_mod_frc_10q
```

10%-downside-occupancy for all 4 quarters:


```{r}

reg_mod_frc_10q %>% 
  as_tibble() %>%
  mutate(occupancy_rate = case_when(
    Region == "North Coast NSW" ~ Q10 / capacity["North Coast"] * 100,
    Region == "South Coast" ~ Q10/ capacity["South Coast"] * 100,
    Region == "Sydney" ~ Q10 / capacity["Sydney"] * 100
  )) %>%
  select(Region, Quarter, occupancy_rate)
```
